---
title: "7.2. 协商连接ID"
anchor: "7.2_Negotiating_Connection_IDs"
weight: 720
rank: "h2"
---

连接ID用于确保数据包稳定路由，详见[第5.1章](#5.1_Connection_ID)。
长包头包含两个连接ID：目标连接ID由接收方指定并用于提供稳定路由；源连接ID供对端设置为目标连接ID。

在握手期间，带有长包头（详见[第17.2章](#17.2_Long_Header_Packets)）的数据包用于设置双端所使用的连接ID。
每端的源连接ID会作为发往该端的数据包的目标连接ID。
在处理完首个初始数据包后，每端将后续发送数据包的目标连接ID字段值设置为其接收的源连接ID字段值。

当客户端发送初始包之前未从服务端收到过初始数据包或重试数据包，则生成不可预测值填充发送的初始包的目标连接ID字段。
目标连接ID的长度{{< req_level MUST >}}至少8字节。
客户端在一条连接上{{< req_level MUST >}}使用同一个目标连接ID，直到收到服务端发来的数据包为止。

客户端发送的首个初始数据包的目标连接ID字段用于确定初始数据包的包保护密钥。
这些密钥在收到重试数据包后变更，详见[QUIC-TLS](https://www.rfc-editor.org/info/rfc9001)[第5.2章](#5.2_Matching_Packets_to_Connections)。

客户端选择一个值填充源连接ID字段，并设置源连接ID长度字段以标识其长度。

客户端发送的首个0-RTT数据包使用其发送的首个初始数据包一致的源连接ID和目标连接ID。

在首次收到从服务端发来的初始数据包或重试数据包后，客户端将服务的提供的源连接ID作为后续发送数据包的目标连接ID，包括任何0-RTT包。
这意味着客户端可能需要在连接建立阶段将目标连接ID字段的值变更两次：
一次是响应服务端发来的重试数据包，一次是响应服务端发来的初始数据包。
一旦客户端收到一个从服务端发来的有效的初始数据包，则其{{< req_level MUST >}}丢弃在该连接上后续接收到的任何带有不同源连接ID值的数据包。

客户端{{< req_level MUST >}}在收到首个初始数据包或首个重试数据包后，更改其后续发送数据包时的目标连接ID值。
服务端{{< req_level MUST >}}基于收到的首个初始数据包设置发送数据包的目标连接ID。
任何针对目标连接ID的后续改动，只允许通过**新连接ID帧**携带的值进行；
如果后续的初始数据包包含不同的源连接ID，则{{< req_level MUST >}}将该包丢弃。
这避免了对多个具有不同源连接ID的初始数据包进行无状态处理可能导致的不可预测的结果。

终端发出的目标连接ID可以在一条连接的生命周期内变更，尤其是在响应连接迁移（[第9章](#9_Connection_Migration)），详见[第5.1.1章](#5.1.1_Issuing_Connection_IDs)。
