---
title: "5.1.1 连接ID"
anchor: "5.1.1_Issuing_Connection_IDs"
weight: 511
rank: "h3"
---

当NEW_CONNECTION_ID帧或RETIRE_CONNECTION_ID帧指向同一个值时，每个连接ID都有一个相关联的序列号用于协助检测。一个终端发出的初始连接ID是通过握手阶段（[第17.2章]()）的长包头的源连接ID字段发送的。初始连接ID的序列号是0。如果发送了传输参数preferred_address，发出的连接ID的序列号就是1。

额外的连接ID通过`新连接ID帧`（[第19.5章]()）传输给对方。新发出的连接ID的序列号{{< req_level MUST >}}递增1。客户端给其发出的第一个目标连接ID字段的连接ID及重试包的连接ID不会分配序列号。

当一个终端发出一个连接ID，其{{< req_level MUST >}}在连接存活期间或在对端通过`撤销连接ID帧`（[第19.16章]()）取消连接前接收携带该连接ID的数据包。连接ID被发出且没有被取消，即是活跃的；任何活跃的连接ID在连接任何时间、对其任何类型的数据包都可以有效使用。这包括被服务端通过推荐地址传输参数发出的连接ID。

一个终端{{< req_level SHOULD >}}确保其对端有足够数量可用且未使用的连接ID。终端使用active_connection_id_limit传输参数指定它们想要维持的活跃连接ID的数目。一个终端{{< req_level MUST_NOT >}}能提供超过对端限制数目的连接ID。
如果`新连接ID帧`也要求终止任何多余的连接ID，终端{{< req_level MAY >}}通过在“退休前”字段包含一个足够大的值来发送临时超过对端限制数量的连接ID。

终端可以根据`新连接ID帧`的“退休前”字段内容添加一些活跃连接ID并终止其他连接ID。在处理完一个`新连接ID帧`并、添加及撤销一些活跃连接ID后，如果活跃连接ID数量仍然超过active_connection_id_limit参数建议的值，终端{{< req_level MUST >}}以CONNECTION_ID_LIMIT_ERROR错误关闭连接。

An endpoint SHOULD ensure that its peer has a sufficient number of available and unused connection IDs. Endpoints advertise the number of active connection IDs they are willing to maintain using the active_connection_id_limit transport parameter. An endpoint MUST NOT provide more connection IDs than the peer's limit. An endpoint MAY send connection IDs that temporarily exceed a peer's limit if the NEW_CONNECTION_ID frame also requires the retirement of any excess, by including a sufficiently large value in the Retire Prior To field.

A NEW_CONNECTION_ID frame might cause an endpoint to add some active connection IDs and retire others based on the value of the Retire Prior To field. After processing a NEW_CONNECTION_ID frame and adding and retiring active connection IDs, if the number of active connection IDs exceeds the value advertised in its active_connection_id_limit transport parameter, an endpoint MUST close the connection with an error of type CONNECTION_ID_LIMIT_ERROR.

An endpoint SHOULD supply a new connection ID when the peer retires a connection ID. If an endpoint provided fewer connection IDs than the peer's active_connection_id_limit, it MAY supply a new connection ID when it receives a packet with a previously unused connection ID. An endpoint MAY limit the total number of connection IDs issued for each connection to avoid the risk of running out of connection IDs; see Section 10.3.2. An endpoint MAY also limit the issuance of connection IDs to reduce the amount of per-path state it maintains, such as path validation status, as its peer might interact with it over as many paths as there are issued connection IDs.

An endpoint that initiates migration and requires non-zero-length connection IDs SHOULD ensure that the pool of connection IDs available to its peer allows the peer to use a new connection ID on migration, as the peer will be unable to respond if the pool is exhausted.

An endpoint that selects a zero-length connection ID during the handshake cannot issue a new connection ID. A zero-length Destination Connection ID field is used in all packets sent toward such an endpoint over any network path.