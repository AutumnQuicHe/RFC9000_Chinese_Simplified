---
title: "A.4. ECN验证算法样例"
anchor: "A.4_Sample_ECN_Validation_Algorithm"
weight: 230400
rank: "h2"
---

每次终端开始在新的网络路径上发送时，它都要判断该路径是否支持ECN；详见[第13.4章](#13.4_Explicit_Congestion_Notification)。如果该路径支持ECN，那么就要将ECN利用起来。终端还可以每隔一段时间重新判断一次被认为不支持ECN的路径。

本节描述了一种用于测试新路径的方法。本算法的意图是展示如何测试一条路径是否支持ECN。终端可以用其他方法实现。

受测试的路径会被指定一种ECN状态，它会是“测试中”、“未知”、“失败”和“支持”中的一种。在状态为“测试中”或“支持”的路径上，终端发送的数据包会带有`ECT`标记——默认是`ECT(0)`；否则，终端发送的数据包上不带标记。

要启动对一条路径的测试，其ECN状态会被置为“测试中”，并且当前的ECN计数被记录为基准值。

测试期间会持续发送数个数据包，或者持续一段指定的时间，这由终端决定。此处的目标不是要限制测试的时长，而是确保发送了足够多经标记的数据包以使得接收到的ECN计数能够清晰地表明该路径会怎样对待经标记的数据包。[第13.4.2章](#13.4.2_ECN_Validation)建议将此时长限制为发送10个数据包的耗时或PTO的三倍大小。

在测试期结束时，该路径的ECN状态会转为“未知”。对**ACK帧**中ECN计数的成功验证会使得该路径的状态从“未知”转为“支持”，除非没有经标记的数据包得到确认。

一旦对ECN计数的验证失败，那么相关路径的ECN状态就会转为“失败”。终端还可以在经标记的数据包全部被认定为丢包或全部被标记上`ECN-CE`时将ECN状态置为“失败”。

按照本算法，能够确保在正确支持ECN的路径上ECN几乎不会被禁用。任何错误地修改了标记的路径都会使得ECN被禁用。对于那些经标记数据包被路径丢弃的罕见情况，短暂的测试期能够限制被丢弃数据包的数量。
