---
title: "10.2.3 在握手期间立即关闭"
anchor: "10.2.3_Immediate_Close_during_the_Handshake"
weight: 1023
rank: "h3"
---

发送**连接关闭帧**时，要确保对端会处理这个帧。通常来说，这意味着将这个帧放到具有最高级别的数据包保护的数据包中发送，以避免数据包被丢弃。在握手确认后（详见《[QUIC-TLS]()》的[第4.1.2章]()），终端{{< req_level MUST >}}在1-RTT数据包中发送任何**连接关闭帧**。然而，在确认握手前，更高级的数据包保护密钥有可能在对端那还不可用，所以{{< req_level MAY >}}使用具有较低数据包保护级别的数据包多发送一个**连接关闭帧**。具体来说：

* 客户端总是知道服务器有没有握手密钥（详见[第17.2.2.1章]()），但是服务器不确定客户端有没有握手密钥。在这种条件下，服务器{{< req_level SHOULD >}}用握手数据包和初始数据包各发送一个**连接关闭帧**来确保它们中的至少一个是客户端可以处理的。

* 在0-RTT数据包中发送**连接关闭帧**的客户端不能确信服务器会同意0-RTT的使用。用初始数据包发送**连接关闭帧**使得服务器更有可能接收到关闭的信号，哪怕应用错误码可能不会被接收到。

* 在确认握手前，对端可能无法处理1-RTT数据包，所以终端{{< req_level SHOULD >}}用握手数据包和1-RTT数据包各发送一个**连接关闭帧**。服务器则{{< req_level SHOULD >}}用初始数据包发送**连接关闭帧**。

用初始数据包或握手数据包发送类型为`0x1d`的**连接关闭帧**会暴露应用状态或被用于更改应用状态。用初始数据包或握手数据包发送时，必须将类型为`0x1d`的**连接关闭帧**替换为类型为`0x1c`的**连接关闭帧**。否则，有关应用状态的信息可能被泄露。终端在转换**连接关闭帧**的类型到`0x1c`时{{< req_level MUST >}}清除原因语句字段的值，并且{{< req_level SHOULD >}}使用`APPLICATION_ERROR`（应用错误）代码。

用不同数据包类型发送的**连接关闭帧**可以被合并至单个UDP数据报中；详见[第12.2章]()。

终端可以用初始数据包发送**连接关闭帧**。这时可能是在响应接收自初始数据包或握手数据包的未通过认证的信息。这样的立即关闭行为可能将合法的连接暴露在拒绝服务攻击之下。QUIC对于握手过程中来自路径上设备的攻击并不提供防御措施；详见[第21.2章]()。然而，如果牺牲发向合法对端的关于错误的反馈，并且终端直接丢弃不合法的数据包而不是用**关闭连接帧**终止连接，那么部分形式的拒绝服务攻击对于攻击者来说会变得更难实施。出于这个原因，如果在缺乏认证的数据包中检测出了错误，那么终端{{< req_level MAY >}}丢弃数据包而不是选择立即关闭。

尚未建立状态的终端，例如在初始数据包中检测到错误的服务器，并不会进入关闭状态。在发送**连接关闭帧**时，没有关于连接的状态的终端不会进入关闭或排空状态。
